<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>文档</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/aui.2.0.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/style.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/swiper.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../layer/need/layer.css" />
		<style>
			html, body {
				height: 100%;
				background: #f4f4f4;
			}
			.back {
				color: #fff;
				font-weight: bold;
				float: left;
				margin-top: 4px;
				margin-right: 4px;
			}
			.head-box1 {
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-flex-flow: row;
				flex-flow: row;
				height: 45px;
			}
			.head-box1-td1 {
				width: 80px;
			}
			.head-box1-td3 {
				width: 80px;
			}
			.head-box1-td2 {
				-webkit-box-flex: 1;
				-webkit-flex: 1;
				flex: 1;
			}
			.ditu-img img {
				width: 25px;
				float: right;
				margin-top: 10px;
				margin-right: 5px;
			}
			.input-box {
				text-align: center;
				color: #fff;
				line-height: 45px;
				margin-top: 2px;
			}
			.fix-box {
				position: relative;
				top: 90px;
				margin-top: 0px;
			}
			.number-box {
				width: 100%;
				padding: 20px;
				border-radius: 5px;
			}
			.number-all {
				background: #fff;
			}
			.number-box input {
				border: 1px solid #FF7F00;
				border-radius: 5px;
				background: #fff;
				height: 40px;
				padding: 10px;
				font-size: 1rem;
			}
			.number-input {
				border: 1px solid #ddd;
				background: #fff;
				width: 100%;
				position: fixed;
				bottom: 1px;
			}
			.aui-row.number-row div {
				padding: 10px 0px 10px 0px;
				font-size: 1.2 rem;
				height: 45px;
			}
			.black-roll {
				background: url('../../image/dd_03.jpg') no-repeat center;
				background-size: 25%;
			}
			.aui-row div {
				border: 1px solid #ddd;
				font-size: 1.5 rem;
				padding: 12px 0px 12px 0px;
			}
			.img-number {
				background: url('../../image/del-number.jpg') no-repeat center;
				background-size: 40%;
				height: 55px;
			}
			.border-right-none {
				border-right: none !important;
			}
			.border-bottom-none {
				border-bottom: none !important;
			}
			.border-top-none {
				border-top: none !important;
			}
			.border-left-none {
				border-left: none !important;
			}
		</style>
	</head>
	<body>
		<div id="headbar"  class="head-bar">
			<div class="head-box1">
				<div class="head-box1-td1">
					<div class="logo-img">
						<span onclick="api.closeWin()" class="iconfont icon-jiantou3 back"></span>
						<img src="../../image/logo2.jpg">
					</div>
				</div>
				<div class="head-box1-td2 input-box">
					支付密码
				</div>
				<div class="head-box1-td3 ditu-img aui-text-center"></div>
			</div>
		</div>
		<div class=" fix-box" >
			<div class="number-box">
				<div class="number-all">
					<div id="numberPwd" class="aui-row number-row">
						<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
						<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
						<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
						<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
						<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
						<div class="aui-col-xs-2 aui-text-center"></div>
					</div>
				</div>
				<div class="btn-box mt-25">
					<div onclick="okbtn()"  class="aui-btn aui-btn-block aui-btn-danger">
						确定
					</div>
				</div>
			</div>
			<div class="number-input">
				<div id="numberKey" class="aui-row">
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-left-none border-top-none border-right-none border-bottom-none" data="1">
						1
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-top-none border-right-none border-bottom-none" data="2">
						2
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-top-none border-bottom-none border-right-none" data="3">
						3
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-left-none border-bottom-none border-right-none" data="4">
						4
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="5">
						5
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="6">
						6
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-left-none border-bottom-none border-right-none" data="7">
						7
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="8">
						8
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="9">
						9
					</div>
					<div  class="aui-col-xs-4 aui-text-center border-left-none border-right-none border-bottom-none" data="-2"></div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-right-none border-bottom-none" data="0">
						0
					</div>
					<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="-1">
						<span class="iconfont icon-shanchu2"></span>
					</div>
				</div>
			</div>
		</div>
		<input type="password" id="payPassword" name="payPassword" value="" style="display: none;" />
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../layer/layer.js"></script>
	<script type="text/javascript" src="../../script/jquery.min.js"></script>
	<script type="text/javascript" src="../../script/my_ajax.js"></script>
	<script type="text/javascript" src="../../script/md5.js"></script>
	<script type="text/javascript" src="../../script/aliPay.js"></script>
	<script type="text/javascript" src="../../script/wxPay.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script>
		var oilInfo = new Object(), resourceMgpriceViewVo = new Object(), mgpriceBatch;
		apiready = function() {
			oilInfo = api.pageParam.oilInfo;
			$api.fixIos7Bar($api.byId('headbar'));
			api.setStatusBarStyle({
				style : 'light',
			});
		}
		var numFlag = 0;
		var keyDivArr = document.getElementById("numberKey").getElementsByTagName("div");
		var pwdDivArr = document.getElementById("numberPwd").getElementsByTagName("div");
		for (var i = 0; i < keyDivArr.length; i++) {
			keyDivArr[i].onclick = function() {
				var dataValue = this.getAttribute("data");
				if (dataValue == -1) {
					if (numFlag > 0) {
						numFlag = numFlag - 1;
						var classList = pwdDivArr[numFlag].getAttribute("class");
						classList = classList.replace("black-roll", "");
						pwdDivArr[numFlag].setAttribute("class", classList);
						var payPassword = document.getElementById("payPassword").value;
						payPassword = payPassword.substring(0, numFlag);
						document.getElementById("payPassword").value = payPassword;
					} else {
						numFlag = 0;
					}
				} else if (dataValue == -2) {
				} else {
					if (numFlag <= 5) {
						var classList = pwdDivArr[numFlag].getAttribute("class");
						classList = classList + " black-roll";
						pwdDivArr[numFlag].setAttribute("class", classList);
						var payPassword = document.getElementById("payPassword").value;
						payPassword += dataValue;
						document.getElementById("payPassword").value = payPassword;
						numFlag = numFlag + 1;
					}
				}
			}
		}
		function okbtn() {
			//清空
			$("#numberPwd div").removeClass("black-roll");
			numFlag = 0;
			buyOil();
		}

		//购买汽油
		var ginfoBillno = "0"//支付关联业务号(团购预购和油卡的业务号)
		//第三方支付
		function buyOil() {
			//先验证支付密码
			var payPwd = $("#payPassword").val();
			var ajaxObject = new Object();
			ajaxObject.url = "/appMemberAjax!checkPayPassword.htm";
			ajaxObject.params = new Object();
			ajaxObject.params.payPassword = hex_md5(payPwd).toUpperCase();
			ajaxObject.onSuccessFunction = function(data) {
				if (api.pageParam.payType == "1") {
					//钱包暂不开通
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "2") {
					//余额
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "3") {
					//团购卷
					queryMyGroupVoucherByPage();
				} else if (api.pageParam.payType == "4") {
					//预购券
					queryMyPreVoucherByPage();
				} else if (api.pageParam.payType == "5") {
					//油卡
					ginfoBillno = api.pageParam.ginfoBillno;
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "6") {
					//微信
					setValue("6");
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "7") {
					//支付宝
					setValue("7");
					saveGasStoreOrder();
				}
			
			}
			baseAjax(ajaxObject);
		}

		//生成加油订单
		function saveGasStoreOrder() {
			var ajaxObject = new Object();
			ajaxObject.url = "/appGasStoreOrderAjax!saveGasStoreOrder.htm";
			ajaxObject.params = new Object();
			ajaxObject.params['resourceMgpriceViewVo.memberBcode'] = api.pageParam.memberCode;//加油站编号
//			ajaxObject.params['resourceMgpriceViewVo.pricesetPrice'] = oilInfo.payPrice;//实付金额
//			ajaxObject.params['resourceMgpriceViewVo.dataCallurl'] = oilInfo.favPrice;//优惠金额
			ajaxObject.params['resourceMgpriceViewVo.dataParam'] = oilInfo.price;//应付金额
			ajaxObject.params['resourceMgpriceViewVo.payType'] = api.pageParam.payType;//支付方式
			ajaxObject.params['resourceMgpriceViewVo.ginfoBillno'] = ginfoBillno;//支付关联业务号(团购预购和油卡的业务号)
			ajaxObject.params['resourceMgpriceViewVo.mgpriceDescription'] = oilInfo.oilNo;//油号
			ajaxObject.params['resourceMgpriceViewVo.mgpriceTechnicalDeviation'] = oilInfo.oilGun;//油枪号
			ajaxObject.params['resourceMgpriceViewVo.mgpriceBusinessDeviation'] = oilInfo.oilNum;//加油数量
			ajaxObject.params['resourceMgpriceViewVo.dataCalltype'] = oilInfo.oilPrice;//油价
			ajaxObject.params['resourceMgpriceViewVo.mgpriceContactname'] = oilInfo.carNo;//车牌号码
//			ajaxObject.params['resourceMgpriceViewVo.dataStr1'] = oilInfo.favorType;//优惠方式（优惠券或折扣卡业务号）
//			ajaxObject.params['resourceMgpriceViewVo.dataStr2'] = oilInfo.accountCode;//优惠业务号
//			ajaxObject.params['resourceMgpriceViewVo.dataStr3'] = oilInfo.isInvoice;//是否开票
//			ajaxObject.params['resourceMgpriceViewVo.dataStr4'] = oilInfo.invoiceName;//开票抬头
			//值补充，测试完删除
			ajaxObject.params['resourceMgpriceViewVo.pricesetPrice'] = oilInfo.price;//实付金额
			ajaxObject.params['resourceMgpriceViewVo.dataCallurl'] = "0";//优惠金额
			ajaxObject.params['resourceMgpriceViewVo.dataStr1'] = "0";//优惠方式（优惠券或折扣卡业务号）
			ajaxObject.params['resourceMgpriceViewVo.dataStr2'] = "";//优惠业务号
			ajaxObject.params['resourceMgpriceViewVo.dataStr3'] = "0";//是否开票
			ajaxObject.params['resourceMgpriceViewVo.dataStr4'] = "";//开票抬头
			ajaxObject.onSuccessFunction = function(data) {
				mgpriceBatch = data.mgpriceBatch;
				resourceMgpriceViewVo.mgpriceBatch = mgpriceBatch;
				resourceMgpriceViewVo.payFunction = success;
				resourceMgpriceViewVo.flag = "1";
				if (api.pageParam.payType == "1") {
					//钱包暂不开通
					success();
				} else if (api.pageParam.payType == "2") {
					//余额
					success();
				} else if (api.pageParam.payType == "3") {
					//团购卷
					success();
				} else if (api.pageParam.payType == "4") {
					//预购卷
					success();
				} else if (api.pageParam.payType == "5") {
					//油卡
					success();
				} else if (api.pageParam.payType == "6") {
					//微信
					wxPay(resourceMgpriceViewVo);
				} else if (api.pageParam.payType == "7") {
					//支付宝
					aliPay(resourceMgpriceViewVo);
				}
			}
			baseAjax(ajaxObject);
		}

		//查询我的团购列表(默认取第一张使用)
		//		function queryMyGroupVoucherByPage(){
		//			var ajaxObject = new Object();
		//			ajaxObject.url = "/appGroupVoucherAjax!queryMySupplementGroupVoucherByPage.htm";
		//			ajaxObject.params = new Object();
		//			ajaxObject.params.whereStr = " bonusRule8 like '%"+ api.pageParam.memberCode +"%'";
		//			ajaxObject.isShowProgress = '1';//不显示加载
		//			ajaxObject.onSuccessFunction = function(data) {
		//				if(data.bonusAccountViewVoList.length > 0){
		//					ginfoBillno = data.bonusAccountViewVoList[0].accountCode;
		//					saveGasStoreOrder();
		//				}else{
		//					api.alert({
		//						title : "提示",
		//						msg : "没有此加油站团购券"
		//                  });
		//				}
		//			}
		//			baseAjax(ajaxObject);
		//		}
		//查询我的预购列表(默认取第一张使用)
		//		function queryMyPreVoucherByPage(){
		//			var ajaxObject = new Object();
		//			ajaxObject.url = "/appPreVoucherAjax!queryMySupplementPreVoucherByPage.htm";
		//			ajaxObject.params = new Object();
		//			ajaxObject.params.whereStr = " bonusRule8 like '%"+ api.pageParam.memberCode +"%'";
		//			ajaxObject.isShowProgress = '1';//不显示加载
		//			ajaxObject.onSuccessFunction = function(data) {
		//				if(data.bonusAccountViewVoList.length > 0){
		//					ginfoBillno = data.bonusAccountViewVoList[0].accountCode;
		//					saveGasStoreOrder();
		//				}else{
		//					api.alert({
		//						title : "提示",
		//						msg : "没有此加油站预购券"
		//                  });
		//				}
		//			}
		//			baseAjax(ajaxObject);
		//		}
		//设置参数对象的属性值
		function setValue(payType) {
			resourceMgpriceViewVo.memberBcode = api.pageParam.memberCode;//加油站编号
//			resourceMgpriceViewVo.pricesetPrice = oilInfo.payPrice;//实付金额
//			resourceMgpriceViewVo.dataCallurl = oilInfo.favPrice;//优惠金额
			resourceMgpriceViewVo.dataParam = oilInfo.price;//应付金额
			resourceMgpriceViewVo.payType = api.pageParam.payType;//支付方式
			resourceMgpriceViewVo.ginfoBillno = "0";//支付关联业务号(团购预购和油卡的业务号)
			resourceMgpriceViewVo.mgpriceDescription = oilInfo.oilNo;//油号
			resourceMgpriceViewVo.mgpriceTechnicalDeviation = oilInfo.oilGun;//油枪号
			resourceMgpriceViewVo.mgpriceBusinessDeviation = oilInfo.oilNum;//加油数量
			resourceMgpriceViewVo.dataCalltype = oilInfo.oilPrice;//油价
			resourceMgpriceViewVo.mgpriceContactname = oilInfo.carNo;//车牌号码
//			resourceMgpriceViewVo.dataStr1 = oilInfo.favorType;//优惠方式（优惠券或折扣卡业务号）
//			resourceMgpriceViewVo.dataStr2 = oilInfo.accountCode;//优惠业务号
//			resourceMgpriceViewVo.dataStr3 = oilInfo.isInvoice;//是否开票
//			resourceMgpriceViewVo.dataStr4 = oilInfo.invoiceName;//开票抬头
			//值补充，测试完删除
			resourceMgpriceViewVo.pricesetPrice = oilInfo.price;//实付金额
			resourceMgpriceViewVo.dataCallurl = "0";//优惠金额
			resourceMgpriceViewVo.dataStr1 = "0";//优惠方式（优惠券或折扣卡业务号）
			resourceMgpriceViewVo.dataStr2 = "";//优惠业务号
			resourceMgpriceViewVo.dataStr3 = "0";//是否开票
			resourceMgpriceViewVo.dataStr4 = "";//开票抬头
		}

		function success() {
			api.openWin({
				name : 'youzhan-zhifu-success',
				url : 'youzhan-zhifu-success.html',
				reload : true,
				pageParam : {
					'mgpriceBatch' : mgpriceBatch,
				},
			});
		}
	</script>
</html>