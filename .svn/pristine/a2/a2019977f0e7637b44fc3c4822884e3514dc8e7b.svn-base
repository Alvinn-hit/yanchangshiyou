<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>文档</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/aui.2.0.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/style.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/swiper.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../layer/need/layer.css" />
		<style>
			html, body {
				height: 100%;
				background: rgba(0,0,0,.1);
			}
			.back {
				color: #fff;
				font-weight: bold;
				float: left;
				margin-top: 4px;
				margin-right: 4px;
			}
			.head-box1 {
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-flex-flow: row;
				flex-flow: row;
				height: 45px;
			}
			.head-box1-td1 {
				width: 80px;
			}
			.head-box1-td3 {
				width: 80px;
			}
			.head-box1-td2 {
				-webkit-box-flex: 1;
				-webkit-flex: 1;
				flex: 1;
			}
			.ditu-img img {
				width: 25px;
				float: right;
				margin-top: 10px;
				margin-right: 5px;
			}
			.input-box {
				text-align: center;
				color: #fff;
				line-height: 45px;
				margin-top: 2px;
			}
			.fix-box {
				position: relative;
				/*top: 90px;
				margin-top: 0px;*/
				height: 440px;
				width: 100%;
				background-color: #fff;
			}
			.number-box {
				/*margin-top: 20px;*/
				width: 100%;
				padding: 20px;
				border-radius: 5px;
			}
			.number-all {
				background: #fff;
			}
			.number-box input {
				border: 1px solid #FF7F00;
				border-radius: 5px;
				background: #fff;
				height: 40px;
				padding: 10px;
				font-size: 1rem;
			}
			.number-input {
				border: 1px solid #ddd;
				background: #fff;
				width: 100%;
				position: fixed;
				bottom: 1px;
			}
			.aui-row.number-row div {
				padding: 10px 0px 10px 0px;
				font-size: 1.2rem;
				height: 45px;
			}
			.black-roll {
				background: url('../../image/dd_03.jpg') no-repeat center;
				background-size: 25%;
			}
			.aui-row div {
				border: 1px solid #ddd;
				font-size: 1.5rem;
				padding: 12px 0px 12px 0px;
			}
			.img-number {
				background: url('../../image/del-number.jpg') no-repeat center;
				background-size: 40%;
				height: 55px;
			}
			.border-right-none {
				border-right: none !important;
			}
			.border-bottom-none {
				border-bottom: none !important;
			}
			.border-top-none {
				border-top: none !important;
			}
			.border-left-none {
				border-left: none !important;
			}
			input{
		        -webkit-text-security:disc;
		        text-security:disc; /*使用指定形状代替文字显示 circle圆圈 disc 圆形 square 正方形*/
	        }
	        .cancel-btn {
	        	position: absolute;
	        	top: 12px;
	        	right: 20px;
	        	font-size: 24px;
	        	cursor: pointer;
	        }
	        .pwd-title {
	        	margin-top: 20px;
	        	text-align: center;
	        	font-size: 1rem;
	        	color: #333;
	        }
		</style>
	</head>
	<body>
		<div class="flex-box">
			<div class="flex-td2" onclick="closecurrent()"></div>
			<div class="fix-box" >
				<div class="cancel-btn" onclick="closecurrent()">×</div>
				<div class="pwd-title">输入密码</div>
				<div class="number-box">
					<div class="number-all">
						<div id="numberPwd" class="aui-row number-row">
							<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
							<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
							<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
							<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
							<div class="aui-col-xs-2 border-right-none aui-text-center"></div>
							<div class="aui-col-xs-2 aui-text-center"></div>
						</div>
					</div>
					<div class="btn-box mt-25">
						<div onclick="okbtn()"  class="aui-btn aui-btn-block aui-btn-danger">
							确定
						</div>
					</div>
				</div>
				<div class="number-input">
					<div id="numberKey" class="aui-row">
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-left-none border-top-none border-right-none border-bottom-none" data="1">
							1
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-top-none border-right-none border-bottom-none" data="2">
							2
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-top-none border-bottom-none border-right-none" data="3">
							3
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-left-none border-bottom-none border-right-none" data="4">
							4
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="5">
							5
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="6">
							6
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-left-none border-bottom-none border-right-none" data="7">
							7
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="8">
							8
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="9">
							9
						</div>
						<div  class="aui-col-xs-4 aui-text-center border-left-none border-right-none border-bottom-none" data="-2"></div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-right-none border-bottom-none" data="0">
							0
						</div>
						<div tapmode="hover-a" class="aui-col-xs-4 aui-text-center border-bottom-none border-right-none" data="-1">
							<span class="iconfont icon-shanchu2"></span>
						</div>
					</div>
				</div>-
			</div>
			<input type="number" id="payPassword" name="payPassword" value="" style="display: none;" />
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../layer/layer.js"></script>
	<script type="text/javascript" src="../../script/jquery.min.js"></script>
	<script type="text/javascript" src="../../script/my_ajax.js"></script>
	<script type="text/javascript" src="../../script/md5.js"></script>
	<script type="text/javascript" src="../../script/wxPay.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script>
		var oilInfo = new Object(), resourceMgpriceViewVo = new Object(), mgpriceBatch;
		var ssgFlag = 0;
		apiready = function() {
			oilInfo = api.pageParam.oilInfo;
			$api.fixIos7Bar($api.byId('headbar'));
			api.setStatusBarStyle({
				style : 'light',
			});
		}
		var numFlag = 0;
		var keyDivArr = document.getElementById("numberKey").getElementsByTagName("div");
		var pwdDivArr = document.getElementById("numberPwd").getElementsByTagName("div");
		for (var i = 0; i < keyDivArr.length; i++) {
			keyDivArr[i].onclick = function() {
				var dataValue = this.getAttribute("data");
				if (dataValue == -1) {
					if (numFlag > 0) {
						numFlag = numFlag - 1;
						var classList = pwdDivArr[numFlag].getAttribute("class");
						classList = classList.replace("black-roll", "");
						pwdDivArr[numFlag].setAttribute("class", classList);
						var payPassword = document.getElementById("payPassword").value;
						payPassword = payPassword.substring(0, numFlag);
						document.getElementById("payPassword").value = payPassword;
					} else {
						numFlag = 0;
					}
				} else if (dataValue == -2) {
				} else {
					if (numFlag <= 5) {
						var classList = pwdDivArr[numFlag].getAttribute("class");
						classList = classList + " black-roll";
						pwdDivArr[numFlag].setAttribute("class", classList);
						var payPassword = document.getElementById("payPassword").value;
						payPassword += dataValue;
						document.getElementById("payPassword").value = payPassword;
						numFlag = numFlag + 1;
					}
				}
			}
		}
		function okbtn() {
			//清空
			$("#numberPwd div").removeClass("black-roll");
			numFlag = 0;
			buyOil();
			$("#payPassword").val("");
		}
		
		function closecurrent() {
			api.closeFrame({
				//			    name: 'my-record-select'
			});
		}

		//购买汽油
		//第三方支付
		function buyOil() {
			//先验证支付密码
			var payPwd = $("#payPassword").val();
			if(!payPwd || payPwd == ""){
				api.toast({msg : '请输入支付密码',duration : 2000,location : 'center'});
				return;
			}
			var ajaxObject = new Object();
			//不隐藏加载
			ajaxObject.isHideProgress = '1';
			ajaxObject.url = "/appMemberAjax!checkPayPassword.htm";
			ajaxObject.params = new Object();
			ajaxObject.params.payPassword = hex_md5(payPwd).toUpperCase();
			ajaxObject.onSuccessFunction = function(data) {
				if (api.pageParam.payType == "1") {
					//钱包暂不开通
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "2") {
					//余额
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "3") {
					//团购卷
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "4") {
					//预购券
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "5") {
					//油卡
					ginfoBillno = api.pageParam.ginfoBillno;
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "6") {
					//微信
					setValue("6");
					saveGasStoreOrder();
				} else if (api.pageParam.payType == "7") {
					//支付宝
					setValue("7");
					saveGasStoreOrder();
				}
			
			}
			baseAjax(ajaxObject);
		}

		//生成加油订单
		function saveGasStoreOrder() {
			var ajaxObject = new Object();
			ajaxObject.url = "/appGasStoreOrderAjax!saveGasStoreOrder.htm";
			ajaxObject.params = new Object();
			ajaxObject.params['resourceMgpriceViewVo.memberBcode'] = api.pageParam.memberCode;//加油站编号
			ajaxObject.params['resourceMgpriceViewVo.pricesetPrice'] = toFixed(oilInfo.payPrice);//实付金额
			ajaxObject.params['resourceMgpriceViewVo.dataCallurl'] = toFixed(oilInfo.favPrice);//优惠金额
			ajaxObject.params['resourceMgpriceViewVo.dataParam'] = toFixed(oilInfo.price);//应付金额
			ajaxObject.params['resourceMgpriceViewVo.payType'] = api.pageParam.payType;//支付方式
			ajaxObject.params['resourceMgpriceViewVo.ginfoBillno'] = oilInfo.ginfoBillno;//支付关联业务号(团购预购和油卡的业务号)
			ajaxObject.params['resourceMgpriceViewVo.mgpriceDescription'] = oilInfo.oilNo;//油号
			ajaxObject.params['resourceMgpriceViewVo.mgpriceTechnicalDeviation'] = oilInfo.oilGun;//油枪号
			ajaxObject.params['resourceMgpriceViewVo.mgpriceBusinessDeviation'] = oilInfo.oilNum;//加油数量
			ajaxObject.params['resourceMgpriceViewVo.dataCalltype'] = oilInfo.oilPrice;//油价
			ajaxObject.params['resourceMgpriceViewVo.mgpriceContactname'] = oilInfo.carNo;//车牌号码
			ajaxObject.params['resourceMgpriceViewVo.dataStr1'] = oilInfo.favorType;//优惠方式
			ajaxObject.params['resourceMgpriceViewVo.dataStr2'] = oilInfo.accountCode;//优惠业务号
			ajaxObject.params['resourceMgpriceViewVo.dataStr3'] = oilInfo.isInvoice;//是否开票
			ajaxObject.params['resourceMgpriceViewVo.dataStr4'] = oilInfo.invoiceName;//开票抬头
			ajaxObject.params['resourceMgpriceViewVo.dataStr12'] = oilInfo.dataStr12;//油站图片
			//不显示加载
			ajaxObject.isShowProgress = '1';
			ajaxObject.onSuccessFunction = function(data) {
				// 惊喜购标示
				ssgFlag = data.ssgFlag;
				
				mgpriceBatch = data.mgpriceBatch;
				resourceMgpriceViewVo.mgpriceBatch = mgpriceBatch;
				resourceMgpriceViewVo.payFunction = success;
				resourceMgpriceViewVo.flag = "1";
				if (api.pageParam.payType == "1") {
					//钱包暂不开通
					success();
				} else if (api.pageParam.payType == "2") {
					//余额
					success();
				} else if (api.pageParam.payType == "3") {
					//团购卷
					success();
				} else if (api.pageParam.payType == "4") {
					//预购卷
					success();
				} else if (api.pageParam.payType == "5") {
					//油卡
					success();
				} else if (api.pageParam.payType == "6") {
					//微信
					wxPay(resourceMgpriceViewVo);
				} else if (api.pageParam.payType == "7") {
					//支付宝
					aliPay(resourceMgpriceViewVo);
				}
			}
			baseAjax(ajaxObject);
		}

		
		//设置参数对象的属性值
		function setValue(payType) {
			resourceMgpriceViewVo.memberBcode = api.pageParam.memberCode;//加油站编号
			resourceMgpriceViewVo.pricesetPrice = toFixed(oilInfo.payPrice);//实付金额
			resourceMgpriceViewVo.dataCallurl = toFixed(oilInfo.favPrice);//优惠金额
			resourceMgpriceViewVo.dataParam = toFixed(oilInfo.price);//应付金额
			resourceMgpriceViewVo.payType = api.pageParam.payType;//支付方式
			resourceMgpriceViewVo.ginfoBillno = "";//支付关联业务号(团购预购和油卡的业务号)
			resourceMgpriceViewVo.mgpriceDescription = oilInfo.oilNo;//油号
			resourceMgpriceViewVo.mgpriceTechnicalDeviation = oilInfo.oilGun;//油枪号
			resourceMgpriceViewVo.mgpriceBusinessDeviation = oilInfo.oilNum;//加油数量
			resourceMgpriceViewVo.dataCalltype = oilInfo.oilPrice;//油价
			resourceMgpriceViewVo.mgpriceContactname = oilInfo.carNo;//车牌号码
			resourceMgpriceViewVo.dataStr1 = oilInfo.favorType;//优惠方式
			resourceMgpriceViewVo.dataStr2 = oilInfo.accountCode;//优惠业务号
			resourceMgpriceViewVo.dataStr3 = oilInfo.isInvoice;//是否开票
			resourceMgpriceViewVo.dataStr4 = oilInfo.invoiceName;//开票抬头
		}

		function success() {
			api.openWin({
				name : 'youzhan-zhifu-success',
				url : 'youzhan-zhifu-success.html',
				reload : true,
				pageParam : {
					'mgpriceBatch' : mgpriceBatch,
					"memberCode" : api.pageParam.memberCode,
					"oilInfo" : api.pageParam.oilInfo,
					"ssgFlag" : ssgFlag,
				},
			});
		}
	</script>
</html>